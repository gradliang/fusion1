/*
// define this module show debug message or not,  0 : disable, 1 : enable
*/
#define LOCAL_DEBUG_ENABLE 0

#include "global612.h"
#include "mpTrace.h"
#include "sensor.h"
#include "peripheral.h"

  

#if((SENSOR_ENABLE == ENABLE) && defined(SENSOR_TYPE_CVBS_INPUT))
#include "../../../../minidv/main/include/setup.h"
/*set video decode tvp5150*/

extern int SensorInputWidth;
extern int SensorInputHeight;


#if 1 //use SW i2c

#define IIC_FLAG_NO_ACK		1
#define IIC_FLAG_ACK		2
#define IIC_FLAG_START		3
#define IIC_FLAG_STOP		4
#define IIC_FLAG_IGNORE		5

#define WAIT_TIME_IIC_DELAY	5//10//35  //20 //5
#define WAIT_TIME_WAIT_ACK	70//200  //160 //40

//--------------------------------------------------------
BYTE ACK1=1, ACK2=1, ACK3=1;

//////////////////////////////////////////
// software simulate i2c base
//////////////////////////////////////////
#define TVP5150_DEVICE_ADDRESS   0xBA//0xBA//0xb8//0xBA//

//#define TVP5150_DEVICE_ADDRESS_READ (0xBB)//0xbb//0xb9//0xBB

#define __tvp5150_i2c_data_high()	(g_psGpio->Gpdat0 |= 0x00000002)
#define __tvp5150_i2c_data_low()		(g_psGpio->Gpdat0 &= 0xfffffffd)
#define __tvp5150_i2c_data_output()	(g_psGpio->Gpdat0 |= 0x00020000)
#define __tvp5150_i2c_data_input()	(g_psGpio->Gpdat0 &= 0xfffdffff)

#define __tvp5150_i2c_clk_high()		(g_psGpio->Gpdat0 |= 0x00000001)
#define __tvp5150_i2c_clk_low()		(g_psGpio->Gpdat0 &= 0xfffffffe)
#define __tvp5150_i2c_clk_output()	(g_psGpio->Gpdat0 |= 0x00010000)
#define __tvp5150_i2c_clk_input()	(g_psGpio->Gpdat0 &= 0xfffeffff)


#define __tvp5150_i2c_read_data()   ((g_psGpio->Gpdat0 & 0x00000002)>>1)
#define __tvp5150_i2c_all_output()	(g_psGpio->Gpdat0 |= 0x00030000)
#define __tvp5150_i2c_set_gpio_mode() (g_psGpio->Gpcfg0 = (g_psGpio->Gpcfg0 & 0xfffcfffc) )


static void tvp5150_i2c_data_high(void)
{
	__tvp5150_i2c_data_high();		IODelay(WAIT_TIME_IIC_DELAY);
}
static void tvp5150_i2c_data_low(void)
{
	__tvp5150_i2c_data_low();		IODelay(WAIT_TIME_IIC_DELAY);
}
static void tvp5150_i2c_data_output(void)
{
	__tvp5150_i2c_data_output();		IODelay(WAIT_TIME_IIC_DELAY);
}
static void tvp5150_i2c_data_input(void)
{
	__tvp5150_i2c_data_input();		IODelay(WAIT_TIME_IIC_DELAY);
}
static void tvp5150_i2c_clk_high(void)
{
	__tvp5150_i2c_clk_high();		IODelay(WAIT_TIME_IIC_DELAY);
}
static void tvp5150_i2c_clk_low(void)
{
	__tvp5150_i2c_clk_low();			IODelay(WAIT_TIME_IIC_DELAY);
}
static void tvp5150_i2c_clk_output(void)
{
	__tvp5150_i2c_clk_output();		IODelay(WAIT_TIME_IIC_DELAY);
}
static void tvp5150_i2c_clk_input(void)
{
	__tvp5150_i2c_clk_input();		IODelay(WAIT_TIME_IIC_DELAY);
}


static BYTE SW_TVP5150_IIC_SetValue(BYTE data1, BYTE condition)
{
    BYTE mask;
    BYTE ret;
	
    __tvp5150_i2c_set_gpio_mode();	// set to GPIO function mode
    __tvp5150_i2c_all_output();		// GP0, GP1 output

	if(condition == IIC_FLAG_START)
	{
		//start condition
		tvp5150_i2c_clk_high();
		tvp5150_i2c_data_high();
		tvp5150_i2c_data_low();
		tvp5150_i2c_clk_low();
	}
	tvp5150_i2c_clk_low();
	mask = 0x80;
	while(mask > 0)
	{
		if((mask & data1) == mask)
			tvp5150_i2c_data_high();
		else 
			tvp5150_i2c_data_low();
		tvp5150_i2c_clk_high();
		tvp5150_i2c_clk_low();
		mask >>= 1;
	}
	
	//cs4349_i2c_data_high();
	__tvp5150_i2c_data_input();		// data = input direction
	IODelay(WAIT_TIME_WAIT_ACK);   //grad
	tvp5150_i2c_clk_high();
	//IODelay(40);  //grad mark
	//IODelay(10);
	IODelay(WAIT_TIME_WAIT_ACK); //Tech use
	if(__tvp5150_i2c_read_data())
	{
		char tmpbuf[64];
		UartOutText("I2C ACK error,");
		sprintf(tmpbuf,"data=0x%02x,condition=%d \r\n",data1,condition);
		UartOutText(tmpbuf);
		//__asm("break 100");
		ret = IIC_FLAG_NO_ACK;
	}
	else
	{
		//UartOutText("ACK OK");
		__tvp5150_i2c_all_output();		// GP0, GP1 output
		ret = IIC_FLAG_ACK;
		//__cs4349_i2c_all_output();	// GP0, GP1 output
    }
        
    tvp5150_i2c_clk_low();
	tvp5150_i2c_data_low();   //along add 20100325 avoid data is high due to not stop
	IODelay(WAIT_TIME_WAIT_ACK);   //grad add

    if(condition == IIC_FLAG_STOP){
        tvp5150_i2c_clk_high();
        tvp5150_i2c_data_high();
    }

    return ret; //IIC_ACK;
}


static BYTE SW_CS4349_IIC_GetValue_NoStop()		// get value, but no stop bit
{
    BYTE data, i;
    
    __tvp5150_i2c_set_gpio_mode();	//set to GPIO function mode
    __tvp5150_i2c_data_input();		// DATA = input
    __tvp5150_i2c_clk_output();		// CLK = output

	tvp5150_i2c_clk_low();
    data = 0;
    for(i = 0; i < 8; i++){
        data <<= 1;
        //cs4349_i2c_clk_low();
        tvp5150_i2c_clk_high();
        data |= __tvp5150_i2c_read_data();
		tvp5150_i2c_clk_low();
    }
    // ACK
    tvp5150_i2c_clk_low();
	IODelay(WAIT_TIME_WAIT_ACK);
    __tvp5150_i2c_all_output();		// GP0, GP1 output
    //cs4349_i2c_data_low(); // ACK    
    tvp5150_i2c_data_low(); // ACK    grad
    tvp5150_i2c_clk_high();
	tvp5150_i2c_clk_low();
	IODelay(WAIT_TIME_WAIT_ACK);
    return data;
}



static BYTE SW_TVP5150_IIC_GetValue()
{
    BYTE data, i;
    
    __tvp5150_i2c_set_gpio_mode();	//set to GPIO function mode
    __tvp5150_i2c_data_input();  // DATA = input
    __tvp5150_i2c_clk_output();  // CLK = output

    tvp5150_i2c_clk_low();
    data = 0;
    for(i = 0; i < 8; i++){
        data <<= 1;        
       // cs4349_i2c_clk_low();
        tvp5150_i2c_clk_high();
        data |= __tvp5150_i2c_read_data();
        tvp5150_i2c_clk_low();		
    }
    // ACK
    tvp5150_i2c_clk_low();
	IODelay(WAIT_TIME_WAIT_ACK);
    __tvp5150_i2c_all_output();  // GP0, GP1 output
    //cs4349_i2c_data_low(); // ACK    

//frank mask    cs4349_i2c_data_high(); // ACK    grad
//frank mask     cs4349_i2c_clk_high();
	
    //__cs4349_i2c_data_input();  // GP1 = input
    
    
    tvp5150_i2c_clk_low();
	tvp5150_i2c_data_low();   //along add 20100325 avoid data is high due to not stop
	IODelay(WAIT_TIME_WAIT_ACK);
    tvp5150_i2c_clk_high();
    tvp5150_i2c_data_high();
    
    return data;
}


static BYTE TVP5150_setRegister(BYTE addr, BYTE data)
{
	ACK1 = SW_TVP5150_IIC_SetValue(TVP5150_DEVICE_ADDRESS, IIC_FLAG_START); 
	ACK2 = SW_TVP5150_IIC_SetValue(addr, IIC_FLAG_IGNORE);
	ACK3 = SW_TVP5150_IIC_SetValue(data, IIC_FLAG_STOP);
}
    

static BYTE TVP5150_readRegister(BYTE addr)
{
	BYTE value;
	ACK1 = SW_TVP5150_IIC_SetValue(TVP5150_DEVICE_ADDRESS, IIC_FLAG_START);
	ACK2 = SW_TVP5150_IIC_SetValue(addr, IIC_FLAG_STOP);
	//__cs4349_i2c_data_high();
	ACK3 = SW_TVP5150_IIC_SetValue((TVP5150_DEVICE_ADDRESS) | 0x01, IIC_FLAG_START);
	value = SW_TVP5150_IIC_GetValue();
	return value;
}


#endif

#if TVP5150_OF_BIT1630

#define HARDWARE_I2CM_ENABLE   			1

#define BIT1630_DEVICE_BANK0_ADDR   0x60
#define BIT1630_DEVICE_BANK1_ADDR   0x62
#define BIT1630_DEVICE_BANK2_ADDR   0x64

static BYTE st_bVidoInputFormat=0xff;  //0 ->PAL  1->NTSC

static BYTE WriteRegister_I2cdevice(BYTE bDevID,BYTE addr, BYTE data)
{
	ACK1 = SW_TVP5150_IIC_SetValue(bDevID, IIC_FLAG_START); 
	ACK2 = SW_TVP5150_IIC_SetValue(addr, IIC_FLAG_IGNORE);
	ACK3 = SW_TVP5150_IIC_SetValue(data, IIC_FLAG_STOP);
}


static BYTE ReadRegister_I2cdevice(BYTE bDevID,BYTE addr)
{
	BYTE value;
	ACK1 = SW_TVP5150_IIC_SetValue(bDevID, IIC_FLAG_START);
	ACK2 = SW_TVP5150_IIC_SetValue(addr, IIC_FLAG_STOP);
	//__cs4349_i2c_data_high();
	ACK3 = SW_TVP5150_IIC_SetValue(bDevID|0x01, IIC_FLAG_START);
	value = SW_TVP5150_IIC_GetValue();
	if ((ACK1==IIC_FLAG_ACK)&&(ACK2==IIC_FLAG_ACK)&&(ACK3==IIC_FLAG_ACK))
	{
		mpDebugPrint("ReadRegister_I2cdevice  ok!!! bDevID=%p addr=%p value=%p",bDevID,addr,value);
	}
	return value;
}

BYTE bBit1630Bank0[]= // device ID add:0x80 or 0xe0 reg:0x0a-0xfe   00->b3
{
0x0a,
#if (FOUR_WINDOW_MODE && (CUSTOMER_BOARD_VER==MP662_YBD_VGA_RGB666))
0x15,0xC7,0xFC,0xAB,0xBB,0x00,
0x82,0x00,0x00,0x00,0x22,0x00,0x00,0x00,0x0A,0x90,0xCD,0x20,0x45,0x66,0x33,0x05,
0x08,0x0C,0x39,0x45,0x00,0x00,0x00,0x00,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x80,0x17,0x03,0x40,0x00,0x71,0x00,
0x00,0x3F,0x3F,0x84,0xE0,0x08,0x9F,0x7A,0x30,0x14,0x3E,0x10,0x4E,0x59,0x30,0x12,
0x07,0x10,0x40,0x58,0x88,0x43,0x43,0x20,0x80,0x23,0x0B,0xD9,0x20,0x75,0xF5,0x20,
0x1D,0xF0,0x01,0x20,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x88,0x06,0x00,0x01,0x00,
0x6C,0xF6,0x1C,0xE0,0x6C,0xF1,0x30,0x6C,0x00,0x00,0x00,0x00,0x00,0x00,0x62,0x18,
0xF9,0xA1,0x04,0x01,0x93,0xC7,0x00,0x34,0x34,0x01,0x06,0x00,0x00,0x00,0x07,0x00,
0x64,0x03,0xCF,0x00,0x00,0x00,0x06,0x00,0x00,0x7B,0x7B,0xF0,0x64,0xBC,0x71,0x61,
0x00,0x04,0x00,0x40,0x90,0x78,0x80,0x00,0x00,0x00,0x0D,0x0E,0x00,0x88,0xA0,0x40,
0x19,0x8D,0x85,0xEA,0xAE,0x32,0xDA,0x30,0x80,0xFE,0x40,0x32,0x00,0x08,0x00,0x00,
0x4D,0xFB,0x71,0x80,0xC3,0x92,0x9B,0x01,0x9B,0x01,0x90,0x81,0x00,0xD0,0x00,0x00,
0x00,0x10,0x80,0x5E,0x8D,0x04,0x04,0x00,0x00,0x00,0x15,0x60,0x3F,0x8E,0xD0,0x03,
0x03,0xFF,0x06,0x00,0x02,0x00,0x00,0x88,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x08,0x00,0x00,0x12,0x03,0x80,0x00,0x80,0x00,0x02,0x0F,0x38
#else
0x15,0xC7,0xFC,0xAB,0xBB,0x00,
0x82,0x00,0x00,0x00,0x22,0x00,0x00,0x00,0x0A,0x90,0xCD,0x20,0xDE,0x66,0x32,0x01,
0x08,0x0C,0x39,0x45,0x00,0x00,0x00,0x00,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x80,0x17,0x03,0x40,0x00,0x71,0x00,
0x00,0x3F,0x3F,0x84,0xE0,0x08,0xA2,0xF8,0x30,0x15,0x3E,0x10,0x9C,0x59,0x30,0x12,
0x07,0x10,0x40,0x58,0x88,0x43,0x43,0x20,0x80,0x23,0x0B,0x4F,0x30,0x75,0xF5,0x20,
0x14,0xF0,0x01,0x20,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x88,0x06,0x00,0x01,0x00,
0x6C,0xDC,0x8D,0xE0,0x6C,0xF1,0x30,0x6C,0x00,0x00,0x00,0x00,0x00,0x00,0x62,0xD5,
0xD9,0x88,0x04,0x01,0x93,0xC7,0x00,0x34,0x34,0x00,0x0D,0x00,0x00,0x00,0x07,0x00,
0x64,0x03,0xCF,0x00,0x00,0x00,0xA4,0x03,0x00,0x7B,0x7B,0xFF,0x84,0xBC,0x46,0x61,
0x00,0x04,0x00,0x40,0x90,0x78,0x80,0x00,0x0C,0x00,0x0D,0x0D,0x00,0x88,0xA0,0x40,
0x19,0x8D,0x85,0xEA,0xA4,0x32,0x78,0x31,0x80,0xFE,0x40,0x32,0x00,0x08,0x00,0x00,
0x4D,0xFB,0x71,0x80,0xC3,0x92,0x9B,0x01,0x9B,0x01,0x90,0x81,0x00,0xD0,0x00,0x00,
0x00,0x10,0x80,0x5E,0x8D,0x04,0x04,0x00,0x00,0x00,0x15,0x60,0x3F,0x8E,0xD0,0x03,
0x03,0x00,0x00,0x00,0x02,0x00,0x00,0x88,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x08,0x00,0x00,0x12,0x03,0x80,0x00,0x80,0x00,0x02,0x0F,0x38
#endif
};

BYTE bBit1630Bank1[]= // BANK 2  addr:0x82 or 0xa2  reg:0x30-0x9e
{
0x30,
#if (FOUR_WINDOW_MODE && (CUSTOMER_BOARD_VER==MP662_YBD_VGA_RGB666))
0x9F,0x9F,0x9F,0x94,0x94,0x94,0xD8,0x27,0xB6,0x94,0x7D,0xF8,0xCD,0x42,0x3B,0x4A,
0x04,0x95,0x35,0xDF,0xE8,0xFD,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x08,
0x00,0x03,0x38,0x40,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,
0x00,0x00,0x00,0x08,0x00,0x00,0x05,0x04,0x00,0x00,0x00,0x00,0x00,0x3F,0x00,0x00,
0x80,0x80,0x80,0x80,0x00,0x00,0x00,0xB1,0x80,0x80,0x80,0x00,0x02,0x44,0x44,0x04,
0xFA,0x38,0xA0,0x4F,0x7F,0x04,0xFB,0x00,0x03,0x2A,0x08,0x00,0x00,0x00,0x08
#else
0x80,0x80,0x80,0x80,0x80,0x80,0xD8,0x27,0x31,0x80,0x80,0x80,0xC0,0x02,0x40,0x40,
0x04,0x95,0x35,0xDF,0xE8,0xFD,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x08,
0x00,0x03,0x38,0x40,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,
0x00,0x00,0x00,0x08,0x00,0x00,0x05,0x04,0x00,0x00,0x00,0x00,0x00,0x3F,0x00,0x00,
0x80,0x80,0x80,0x80,0x00,0x00,0x00,0xB1,0x80,0x80,0x80,0x00,0x02,0x44,0x44,0x04,
0xFA,0x38,0xA0,0x4F,0x7F,0x04,0xFB,0x00,0x0C,0x31,0x00,0x00,0x00,0x00,0x00
#endif
};

BYTE bBit1630Bank3[]= // BANK 3
{
0x00,
#if (FOUR_WINDOW_MODE && (CUSTOMER_BOARD_VER==MP662_YBD_VGA_RGB666))
0x01,0x02,0x03,0x05,0x06,0x07,0x09,0x0A,0x0B,0x0D,0x0E,0x10,0x11,0x12,0x14,0x15,
0x16,0x18,0x19,0x1B,0x1C,0x1D,0x1F,0x20,0x22,0x23,0x24,0x26,0x27,0x28,0x2A,0x2B,
0x2D,0x2E,0x2F,0x31,0x32,0x33,0x35,0x36,0x37,0x39,0x3A,0x3B,0x3D,0x3E,0x40,0x41,
0x42,0x43,0x45,0x46,0x47,0x49,0x4A,0x4B,0x4D,0x4E,0x4F,0x50,0x52,0x53,0x54,0x56,
0x57,0x58,0x59,0x5A,0x5C,0x5D,0x5E,0x60,0x61,0x62,0x63,0x64,0x65,0x67,0x68,0x69,
0x6A,0x6B,0x6C,0x6E,0x6F,0x70,0x71,0x72,0x73,0x74,0x76,0x77,0x78,0x79,0x7A,0x7B,
0x7C,0x7D,0x7E,0x7F,0x80,0x81,0x82,0x83,0x84,0x85,0x86,0x87,0x88,0x89,0x8A,0x8B,
0x8C,0x8D,0x8E,0x8F,0x90,0x91,0x92,0x93,0x94,0x94,0x95,0x96,0x97,0x98,0x99,0x9A,
0x9B,0x9C,0x9C,0x9D,0x9E,0x9F,0xA0,0xA1,0xA2,0xA3,0xA3,0xA4,0xA5,0xA6,0xA7,0xA7,
0xA8,0xA9,0xAA,0xAB,0xAC,0xAC,0xAD,0xAE,0xAF,0xB0,0xB1,0xB1,0xB2,0xB3,0xB4,0xB5,
0xB5,0xB6,0xB7,0xB8,0xB9,0xBA,0xBA,0xBB,0xBC,0xBD,0xBD,0xBE,0xBF,0xC0,0xC1,0xC1,
0xC2,0xC3,0xC4,0xC5,0xC5,0xC6,0xC7,0xC8,0xC9,0xC9,0xCA,0xCB,0xCC,0xCC,0xCD,0xCE,
0xCF,0xCF,0xD0,0xD1,0xD2,0xD3,0xD3,0xD4,0xD5,0xD6,0xD7,0xD7,0xD8,0xD9,0xDA,0xDA,
0xDB,0xDC,0xDD,0xDD,0xDE,0xDF,0xE0,0xE0,0xE1,0xE2,0xE3,0xE3,0xE4,0xE5,0xE6,0xE7,
0xE7,0xE8,0xE9,0xEA,0xEA,0xEB,0xEC,0xED,0xED,0xEE,0xEF,0xF0,0xF0,0xF1,0xF2,0xF3,
0xF3,0xF4,0xF5,0xF6,0xF7,0xF7,0xF8,0xF9,0xFA,0xFB,0xFB,0xFC,0xFD,0xFE,0xFE,0xFF,
#else //Three window
0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,
0x80,0x81,0x82,0x83,0x84,0x85,0x86,0x87,0x88,0x89,0x8A,0x8B,0x8C,0x8D,0x8E,0x8F,
0x90,0x91,0x92,0x93,0x94,0x95,0x96,0x97,0x98,0x99,0x9A,0x9B,0x9C,0x9D,0x9E,0x9F,
0xA0,0xA1,0xA2,0xA3,0xA4,0xA5,0xA6,0xA7,0xA8,0xA9,0xAA,0xAB,0xAC,0xAD,0xAE,0xAF,
0xB0,0xB1,0xB2,0xB3,0xB4,0xB5,0xB6,0xB7,0xB8,0xB9,0xBA,0xBB,0xBC,0xBD,0xBE,0xBF,
0xC0,0xC1,0xC2,0xC3,0xC4,0xC5,0xC6,0xC7,0xC8,0xC9,0xCA,0xCB,0xCC,0xCD,0xCE,0xCF,
0xD0,0xD1,0xD2,0xD3,0xD4,0xD5,0xD6,0xD7,0xD8,0xD9,0xDA,0xDB,0xDC,0xDD,0xDE,0xDF,
0xE0,0xE1,0xE2,0xE3,0xE4,0xE5,0xE6,0xE7,0xE8,0xE9,0xEA,0xEB,0xEC,0xED,0xEE,0xEF,
0xF0,0xF1,0xF2,0xF3,0xF4,0xF5,0xF6,0xF7,0xF8,0xF9,0xFA,0xFB,0xFC,0xFD,0xFE,0xFF,

#endif
};

//NTSC
#if 1//THREE_WINDOW_MODE
BYTE bBit1630Bank0_Ntsc[]= // device ID add:0x80 or 0xe0 reg:0x0a-0xfe   // 0x0a,at first pos
{
0x0a,
0x15,0xC7,0xFC,0xAB,0xBB,0x00,
0x82,0x00,0x00,0x00,0x22,0x00,0x00,0x00,0x0A,0x90,0xCD,0x20,0xDE,0x58,0x32,0x01,
0x08,0x0C,0x39,0x45,0x00,0x00,0x00,0x00,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x80,0x17,0x03,0x40,0x00,0x71,0x00,
0x00,0x3F,0x3F,0x84,0xE0,0x08,0xA2,0xF8,0x30,0x15,0x3E,0x10,0x9C,0x59,0x30,0x12,
0x07,0x10,0x40,0x58,0x88,0x43,0x43,0x20,0x80,0x23,0x0B,0x4F,0x30,0x75,0xF5,0x20,
0x14,0xF0,0x01,0x20,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x88,0x06,0x00,0x01,0x00,
0x6C,0xDC,0x8D,0xE0,0x6C,0xF1,0x30,0x6C,0x00,0x00,0x00,0x00,0x00,0x00,0x62,0xD5,
0xD9,0x88,0x04,0x01,0x93,0xC7,0x00,0x34,0x34,0x00,0x0D,0x00,0x00,0x00,0x01,0x00,
0x64,0x03,0xCF,0x00,0x00,0x00,0xA4,0x03,0x00,0x7B,0x7B,0xFF,0x84,0xBC,0x46,0x61,
0x00,0x04,0x00,0x40,0x90,0x78,0x80,0x00,0x0C,0x00,0x0D,0x0D,0x00,0x88,0xA0,0x40,
0x19,0x8D,0x85,0xEA,0xA4,0x32,0x78,0x31,0x80,0xFE,0x40,0x32,0x00,0x08,0x00,0x00,
0x4D,0xFB,0x71,0x80,0xC3,0x92,0x9B,0x01,0x9B,0x01,0x90,0x81,0x00,0xD0,0x00,0x00,
0x00,0x10,0x80,0x5E,0x8D,0x04,0x04,0x00,0x00,0x00,0x15,0x60,0x3F,0x8E,0xD0,0x03,
0x03,0x00,0x00,0x00,0x02,0x00,0x00,0x88,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x08,0x00,0x00,0x12,0x03,0x80,0x00,0x80,0x00,0x02,0x0F,0x38
};

BYTE bBit1630Bank1_Ntsc[]= // BANK 2  addr:0x82 or 0xa2  reg:0x30-0x9e
{
0x30,
0x80,0x80,0x80,0x80,0x80,0x80,0xD8,0x27,0xB6,0x80,0x80,0x80,0xC0,0x02,0x40,0x40,
0x04,0x95,0x35,0xDF,0xE8,0xFD,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x08,
0x00,0x03,0x38,0x40,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,
0x00,0x00,0x00,0x08,0x00,0x00,0x05,0x04,0x00,0x00,0x00,0x00,0x00,0x3F,0x00,0x00,
0x80,0x80,0x80,0x80,0x00,0x00,0x00,0xB1,0x80,0x80,0x80,0x00,0x02,0x44,0x44,0x04,
0xFA,0x38,0xA0,0x4F,0x7F,0x04,0xFB,0x00,0x0C,0x31,0x00,0x00,0x00,0x00,0x00
};

BYTE bBit1630Bank3_Ntsc[]= // BANK 3
{
0x00,
0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,
0x80,0x81,0x82,0x83,0x84,0x85,0x86,0x87,0x88,0x89,0x8A,0x8B,0x8C,0x8D,0x8E,0x8F,
0x90,0x91,0x92,0x93,0x94,0x95,0x96,0x97,0x98,0x99,0x9A,0x9B,0x9C,0x9D,0x9E,0x9F,
0xA0,0xA1,0xA2,0xA3,0xA4,0xA5,0xA6,0xA7,0xA8,0xA9,0xAA,0xAB,0xAC,0xAD,0xAE,0xAF,
0xB0,0xB1,0xB2,0xB3,0xB4,0xB5,0xB6,0xB7,0xB8,0xB9,0xBA,0xBB,0xBC,0xBD,0xBE,0xBF,
0xC0,0xC1,0xC2,0xC3,0xC4,0xC5,0xC6,0xC7,0xC8,0xC9,0xCA,0xCB,0xCC,0xCD,0xCE,0xCF,
0xD0,0xD1,0xD2,0xD3,0xD4,0xD5,0xD6,0xD7,0xD8,0xD9,0xDA,0xDB,0xDC,0xDD,0xDE,0xDF,
0xE0,0xE1,0xE2,0xE3,0xE4,0xE5,0xE6,0xE7,0xE8,0xE9,0xEA,0xEB,0xEC,0xED,0xEE,0xEF,
0xF0,0xF1,0xF2,0xF3,0xF4,0xF5,0xF6,0xF7,0xF8,0xF9,0xFA,0xFB,0xFC,0xFD,0xFE,0xFF,

};
#endif

static void Init_Bit1630()
{
	DWORD i;
	SDWORD sdwRet;

#if HARDWARE_I2CM_ENABLE
    I2CM_Init();
	//TaskSleep(1000);

#if 1//THREE_WINDOW_MODE
	if (st_bVidoInputFormat)
	{
		I2CM_Write_BustMode(BIT1630_DEVICE_BANK0_ADDR,bBit1630Bank0_Ntsc,sizeof(bBit1630Bank0_Ntsc));
		I2CM_Write_BustMode(BIT1630_DEVICE_BANK1_ADDR,bBit1630Bank1_Ntsc,sizeof(bBit1630Bank1_Ntsc));
		I2CM_WtReg8Data8(BIT1630_DEVICE_BANK1_ADDR,0x38,0x31); 
		I2CM_Write_BustMode(BIT1630_DEVICE_BANK2_ADDR,bBit1630Bank3_Ntsc,sizeof(bBit1630Bank3_Ntsc));
		I2CM_WtReg8Data8(BIT1630_DEVICE_BANK1_ADDR,0x38,0xB6); // b1->b6  20150915 zheng 
	}
	else
#endif
	{
		I2CM_Write_BustMode(BIT1630_DEVICE_BANK0_ADDR,bBit1630Bank0,sizeof(bBit1630Bank0));
		I2CM_Write_BustMode(BIT1630_DEVICE_BANK1_ADDR,bBit1630Bank1,sizeof(bBit1630Bank1));
		I2CM_WtReg8Data8(BIT1630_DEVICE_BANK1_ADDR,0x38,0x31); 
		I2CM_Write_BustMode(BIT1630_DEVICE_BANK2_ADDR,bBit1630Bank3,sizeof(bBit1630Bank3));
		I2CM_WtReg8Data8(BIT1630_DEVICE_BANK1_ADDR,0x38,0xB6); // b1->b6  20150915 zheng 
	}
#else
	for (i=0;i<sizeof(bBit1630Bank0);i++)
	{
			WriteRegister_I2cdevice(BIT1630_DEVICE_BANK0_ADDR,0x0a+i,bBit1630Bank0[i]); //WriteRegister_I2cdevice I2CM_WtReg8Data8
			TaskSleep(10);
	}
	for (i=0;i<sizeof(bBit1630Bank1);i++)
	{
			WriteRegister_I2cdevice(BIT1630_DEVICE_BANK1_ADDR,0x30+i,bBit1630Bank1[i]);
			TaskSleep(10);
	}
#endif
	//InitBrightnessContrast();
	
}

BYTE CheckVideoFormatToInitBit1630( BYTE bForceInit)
{
BYTE bNewFormat=VideoFormat_Is_Ntsc();

	if (bForceInit || st_bVidoInputFormat!=bNewFormat)
	{
		st_bVidoInputFormat=bNewFormat;
		 Init_Bit1630();
	}

	return bNewFormat;
}

#endif


void Set_CVBS_Input_resolution(void)
{
#if MINIDV_YBD_FUNCION && TVP5150_OF_BIT1630
BYTE bFormat=CheckVideoFormatToInitBit1630(0);

	if (bFormat)
		API_SetCVBS_InputSize(720,480);
	else
		API_SetCVBS_InputSize(720,576);
#else	
	//API_SelectChannel(0); //RUN PAL mode
  switch(API_Get_Selected_Channel())
  {
  	case 0: /*720x576 (625 line)  720 */
	  API_SetCVBS_InputSize(720,576);
	  break;

	case 1:	
    default: /*720x480 (525 line): */
	  API_SetCVBS_InputSize(720,480);
  }
#endif

  SensorInputWidth  = CVBS_getInputWidth();
  SensorInputHeight = CVBS_getInputHeight()<<1 ;
}

void TVP5150_setting(void)
{
  Gpio_Config2GpioFunc(GPIO_GPIO_0, GPIO_OUTPUT_MODE, GPIO_DATA_HIGH, 1);
  Gpio_Config2GpioFunc(GPIO_GPIO_1, GPIO_OUTPUT_MODE, GPIO_DATA_HIGH, 1);

  //H sync set FGPIO[29] to function 2
  g_psGpio->Fgpcfg[1] &= (~(BIT29|BIT13));
  g_psGpio->Fgpcfg[1] |=(BIT29);

  //V sync set FGPIO[32] to function 2
  g_psGpio->Fgpcfg[2] &= (~(BIT16|BIT0));
  g_psGpio->Fgpcfg[2] |=(BIT16);

  //set Pclk to function 2
  g_psGpio->Fgpcfg[0] &= (~(BIT30|BIT14));
  g_psGpio->Fgpcfg[0] |=(BIT30);

  //set Y0
  g_psGpio->Fgpcfg[0] &= (~(BIT31|BIT15));
  g_psGpio->Fgpcfg[0] |=(BIT31);

  //set Y1-5
  g_psGpio->Fgpcfg[1] &= (~(0x061f061f));
  g_psGpio->Fgpcfg[1] |=(0x061f0000);


  MP_DEBUG1("g_psGpio->Fgpcfg[0] =0x%x",g_psGpio->Fgpcfg[0]);
  MP_DEBUG1("g_psGpio->Fgpcfg[1] =0x%x",g_psGpio->Fgpcfg[1]);
  MP_DEBUG1("g_psGpio->Fgpcfg[2] =0x%x",g_psGpio->Fgpcfg[2]);
  MP_DEBUG1("g_psGpio->Fgpcfg[3] =0x%x",g_psGpio->Fgpcfg[3]);

  Gpio_Config2GpioFunc(GPIO_FGPIO_27, GPIO_OUTPUT_MODE, GPIO_DATA_HIGH, 1);
  MP_DEBUG("#### SET FGPIO27 High ####");
  //IODelay(1000);

#if TVP5150_OF_BIT1630
//Init_Bit1630();
	CheckVideoFormatToInitBit1630(1);
return;
#endif
  TVP5150_setRegister( 0x03, 0xff);//default: 0x6d
  //TVP5150_setRegister( 0x06, 0x00); 		// color killer
  TVP5150_setRegister( 0x08, 0x4C);
  TVP5150_setRegister( 0x09, 96);			// brightness
  TVP5150_setRegister( 0x0A, 128 + 50+20); 	// saturation
  TVP5150_setRegister( 0x0C, 120);			// contrast
//  TVP5150_setRegister( 0x0d, 0);
  TVP5150_setRegister( 0x0d, 0x7);
  TVP5150_setRegister( 0x0E, 3);
//  TVP5150_setRegister( 0x0f, 0x02);

  //frank add  fine tuning       
  TVP5150_setRegister( 0x16, 0x5b);//H sync postion

//TVP5150_setRegister( 0xCF, 0x1);//full field

#if TVP5150_DETECT_ON
  TVP5150_setRegister( 0xc1, BIT6|BIT0);
#endif

#if MINIDV_YBD_FUNCION
    TVP5150_setRegister( 0x00, 0x02);//A1P1B
    TVP5150_setRegister( 0x11, 0x04);
    TVP5150_setRegister( 0x12, 0x03);
	API_SelectChannel(1);
#endif

#if 0 //debug
  MP_ALERT("TVP5150 read[0x00] =0x%x ###", TVP5150_readRegister(0x00));

  MP_ALERT("TVP5150 read[0x03] =0x%x ###", TVP5150_readRegister(0x03));
  MP_ALERT("TVP5150 read[0x06] =0x%x ###", TVP5150_readRegister(0x06));
  MP_ALERT("TVP5150 read[0x08] =0x%x ###", TVP5150_readRegister(0x08));
  MP_ALERT("TVP5150 read[0x09] =0x%x ###", TVP5150_readRegister(0x09));
  MP_ALERT("TVP5150 read[0x0a] =0x%x ###", TVP5150_readRegister(0x0a));
  
  MP_ALERT("TVP5150 read[0x0b] =0x%x ###", TVP5150_readRegister(0x0b));
  MP_ALERT("TVP5150 read[0x0c] =0x%x ###", TVP5150_readRegister(0x0c));
  MP_ALERT("TVP5150 read[0x0d] =0x%x ###", TVP5150_readRegister(0x0d));
  MP_ALERT("TVP5150 read[0x0e] =0x%x ###", TVP5150_readRegister(0x0e));
  MP_ALERT("TVP5150 read[0x0f] =0x%x ###", TVP5150_readRegister(0x0f));

  MP_ALERT("TVP5150 read[0x11] =0x%x ###", TVP5150_readRegister(0x11));
  MP_ALERT("TVP5150 read[0x12] =0x%x ###", TVP5150_readRegister(0x12));
  MP_ALERT("TVP5150 read[0x13] =0x%x ###", TVP5150_readRegister(0x13));
  MP_ALERT("TVP5150 read[0x14] =0x%x ###", TVP5150_readRegister(0x14));
  MP_ALERT("TVP5150 read[0x16] =0x%x ###", TVP5150_readRegister(0x16));
  MP_ALERT("TVP5150 read[0x18] =0x%x ###", TVP5150_readRegister(0x18));
  MP_ALERT("TVP5150 read[0x19] =0x%x ###", TVP5150_readRegister(0x19));
  MP_ALERT("TVP5150 read[0x84] =0x%x ###", TVP5150_readRegister(0x84));
  MP_ALERT("TVP5150 read[0x85] =0x%x ###", TVP5150_readRegister(0x85));

MP_ALERT("TVP5150 read[0x1A] =0x%x ###", TVP5150_readRegister(0x1A));

MP_ALERT("TVP5150 read[0x1B] =0x%x ###", TVP5150_readRegister(0x1B));

MP_ALERT("TVP5150 read[0x8A] =0x%x ###", TVP5150_readRegister(0x8A));

MP_ALERT("TVP5150 read[0xcf] =0x%x ###", TVP5150_readRegister(0xcf));
 
#endif
MP_ALERT("TVP5150 read[0xcf] =0x%x ###", TVP5150_readRegister(0xcf));

}


#if !MINIDV_YBD_FUNCION
void TVP5150_SetChannel(void)
{
  if(API_Get_Selected_Channel() == 0)
  {  	
    TVP5150_setRegister( 0x00, 0x00);//A1P1A
  }
  else
  {
    TVP5150_setRegister( 0x00, 0x02);//A1P1B
  }
}
#endif

#if TVP5150_OF_BIT1630
#if BIT1630_DETECT_SIGNAL_FORMAT
BYTE  VideoSignalStatus()
{
#if HARDWARE_I2CM_ENABLE
	BYTE bData=I2CM_RdReg8Data8(BIT1630_DEVICE_BANK1_ADDR,0xe5);  
#else
	BYTE bData=ReadRegister_I2cdevice(BIT1630_DEVICE_BANK1_ADDR,0xe5);
#endif
	//MP_ALERT("VideoSignalStatus=0x%x",bData);

	return (bData);
}
#endif
BYTE  VideoFormat_Is_Ntsc()
{
#if HARDWARE_I2CM_ENABLE
	BYTE bData=I2CM_RdReg8Data8(BIT1630_DEVICE_BANK1_ADDR,0xcd);  //0x1CD[1]  0:50HZ PAL  1:60HZ NTSC  0xE6[3]
#else
	BYTE bData=ReadRegister_I2cdevice(BIT1630_DEVICE_BANK1_ADDR,0xcd);
#endif
	MP_ALERT("VideoFormat_Is_Ntsc=0x%x",bData);

	return (bData&BIT1);
}

BYTE  Brightness_Roll()
{
#if HARDWARE_I2CM_ENABLE
	BYTE bData=I2CM_RdReg8Data8(BIT1630_DEVICE_BANK1_ADDR,0x3a);
#else
	BYTE bData=ReadRegister_I2cdevice(BIT1630_DEVICE_BANK1_ADDR,0x3a);
#endif
	MP_ALERT("Brightness_Roll read=0x%x",bData);
	DWORD dwData=bData+10;
	if (dwData>200)
		dwData=100;
	if (dwData<100)
		dwData=100;
	bData=dwData;
#if HARDWARE_I2CM_ENABLE
	I2CM_WtReg8Data8(BIT1630_DEVICE_BANK1_ADDR,0x3a,bData); 
#else
	WriteRegister_I2cdevice(BIT1630_DEVICE_BANK1_ADDR,0x3a,bData); 
#endif
	g_psSetupMenu->bInputBrightness=bData;
	//WriteSetupChg();

	return (bData);
}

BYTE  Contrast_Roll()
{
#if HARDWARE_I2CM_ENABLE
	BYTE bData=I2CM_RdReg8Data8(BIT1630_DEVICE_BANK1_ADDR,0x3b);
#else
	BYTE bData=ReadRegister_I2cdevice(BIT1630_DEVICE_BANK1_ADDR,0x3b);
#endif
	MP_ALERT("Contrast_Roll read=0x%x",bData);
	DWORD dwData=bData+(255-100)/10;
	if (dwData>255)
		dwData=100;
	if (dwData<100)
		dwData=100;
	bData=dwData;
#if HARDWARE_I2CM_ENABLE
	I2CM_WtReg8Data8(BIT1630_DEVICE_BANK1_ADDR,0x3b,bData); 
#else
	WriteRegister_I2cdevice(BIT1630_DEVICE_BANK1_ADDR,0x3b,bData); 
#endif
	g_psSetupMenu->bInputContrast=bData;
	//WriteSetupChg();

	return (bData);
}

void InitBrightnessContrast()
{
#if HARDWARE_I2CM_ENABLE
	I2CM_WtReg8Data8(BIT1630_DEVICE_BANK1_ADDR,0x3a,g_psSetupMenu->bInputBrightness); 
#else
	WriteRegister_I2cdevice(BIT1630_DEVICE_BANK1_ADDR,0x3a,g_psSetupMenu->bInputBrightness); 
#endif
#if HARDWARE_I2CM_ENABLE
	I2CM_WtReg8Data8(BIT1630_DEVICE_BANK1_ADDR,0x3b,g_psSetupMenu->bInputContrast); 
#else
	WriteRegister_I2cdevice(BIT1630_DEVICE_BANK1_ADDR,0x3b,g_psSetupMenu->bInputContrast); 
#endif

}
#endif

#if 1//TVP5150_DETECT_ON

#if TVP5150_OF_BIT1630
BYTE  VideoInputOn()
{
#if HARDWARE_I2CM_ENABLE
	BYTE bData=I2CM_RdReg8Data8(BIT1630_DEVICE_BANK1_ADDR,0xe5); //0xcd bit2 0xe5 bit1
#else
	BYTE bData=ReadRegister_I2cdevice(BIT1630_DEVICE_BANK1_ADDR,0xe5);
#endif
	//MP_ALERT("VideoInputOn=0x%x",bData);

	return (bData&0x02);
}


#else

WORD Get_TVP5150_Register(BYTE addr)
{
	WORD value;
	ACK1 = SW_TVP5150_IIC_SetValue(TVP5150_DEVICE_ADDRESS, IIC_FLAG_START);
	ACK2 = SW_TVP5150_IIC_SetValue(addr, IIC_FLAG_STOP);
	//__cs4349_i2c_data_high();
	ACK3 = SW_TVP5150_IIC_SetValue((TVP5150_DEVICE_ADDRESS) | 0x01, IIC_FLAG_START);
	if ((ACK1==IIC_FLAG_NO_ACK)||(ACK2==IIC_FLAG_NO_ACK)||(ACK3==IIC_FLAG_NO_ACK))
		value=0xffff;
	else
		value = SW_TVP5150_IIC_GetValue();


	return value;
	//return TVP5150_readRegister(addr);
}

BYTE  Set_TVP5150_Register(BYTE addr, BYTE data)
{
			TVP5150_setRegister(addr,data);
}

#endif


#endif

#if (MOTION_DETECT == ENABLE)

//SKIP_PIXEL must be even.
#define SKIP_PIXEL  16

DWORD CVBS_Sensor_GetAvgLuminance(void)
{
  //MP_ALERT("## %s ##", __FUNCTION__);													
  DWORD value=0;
  DWORD x,y;
  WORD W=CVBS_getRecordWidth();
  WORD H=CVBS_getRecordHeight();
  BYTE *GetBufPtr;
  BYTE *CurPtr;
  BYTE *CurYPtr;
  DWORD RowSumValue,TotalRowValue;

  DWORD debugCnt = 0;

  extern ST_IMGWIN SensorInWin[3];
  extern BYTE Motion_Detection_Value;

  GetBufPtr = SensorInWin[0].pdwStart;
    
#if (SKIP_PIXEL%2 == 0)
  TotalRowValue = 0;
  CurYPtr       = GetBufPtr;

  for(y=0; y<H ; y+= SKIP_PIXEL)
  {
    RowSumValue = 0;
    CurPtr      = CurYPtr;
    for( x=0 ; x<W ;x += SKIP_PIXEL)
    {
      RowSumValue += *CurPtr;
      CurPtr += (SKIP_PIXEL<<2);
    }
    RowSumValue /= (W/SKIP_PIXEL/4);
    //MP_ALERT("RowSumValue = %d", RowSumValue);
    CurYPtr += (W<<2)*SKIP_PIXEL;
    TotalRowValue += RowSumValue;
  }
  TotalRowValue /= (H/SKIP_PIXEL/4);
#endif 

  value = TotalRowValue;

  MP_DEBUG2(" Motion_Detection_Value =%d, value =%d", Motion_Detection_Value, value);
	
  return (DWORD)value; ;                     
}



#endif


#endif



