/*** FileName     AudioDac_ES7240.c** Author       Eddy* Date         2011.08.02** Description  Driver for CODEC ES7240* */ #define LOCAL_DEBUG_ENABLE 0/*// Include section */#include "global612.h"#include "mpTrace.h"#include "audio_hal.h"#if (AUDIO_DAC == DAC_ES7240)#define ES7240_DELAY()	__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");__asm("nop");//Caculation is based on CPU time 96MHzvoid DAC_delay_ns1(DWORD ns){	DWORD i;	ns = ns / 5;	//One instruction consume 10ns	for(i = 0; i < ns; i++)		__asm("nop");}static DWORD gpcfg1;static DWORD gpdat1;void ES7240_GPIO_Init(){	//mpDebugPrint("ES7240_GPIO_Init");}/* *    Mapping 16 level of UI volune value to 128 level hardware value */void ES7240_ChgVolume(WORD vol){	//mpDebugPrint("ES7240 volume level: %d", vol);}void ES7240_SetDACSampleRate(DWORD sRate){	register CLOCK *audio_clock;	int data;	audio_clock = (CLOCK *) (CLOCK_BASE);	audio_clock->PLL3Cfg = 0x00770107;	int PLL2CLOCK = (Clock_PllFreqGet(CLOCK_PLL2_INDEX)/1000000);		if (AUDIO_DAC_USING_PLL2)	{		mpDebugPrint("ES7240 using PLL2 Clock Freq.: %d", PLL2CLOCK);	}	else	{		mpDebugPrint("ES7240 using PLL3");	}		mpDebugPrint("ES7240 Samplerate: %d", sRate);	if (     (sRate > 7000)  && (sRate < 11000))	// Set 8kHz status	{	#if AUDIO_DAC_USING_PLL2	if   (PLL2CLOCK == 120)	{        audio_clock->AudClkC = 0x000013BC;//120/5/12 = 2Mhz(MCLK)        AIU_SET_LRCLOCK_LEN(0x3F);		// lrclk set as 7.8125khz		}	else if (PLL2CLOCK == 132)    {    	audio_clock->AudClkC = 0x000013CC;//138/5/13 = 2.03Mhz(MCLK)        AIU_SET_LRCLOCK_LEN(0x3F); 		// lrclk set as 7.9326khz		}	else if (PLL2CLOCK == 138)    {    	audio_clock->AudClkC = 0x000013AD;//138/6/11 = 2.09Mhz(MCLK)        AIU_SET_LRCLOCK_LEN(0x3F); 		// lrclk set as 8.16khz		}	else if (PLL2CLOCK == 144)    {    	audio_clock->AudClkC = 0x000013BD;//144/6/12 = 2Mhz(MCLK)        AIU_SET_LRCLOCK_LEN(0x3F);  	// lrclk set as 7.8khz		}	else if (PLL2CLOCK == 150)	{		audio_clock->AudClkC = 0x000013BD;//150/5/12 = 2.083Mhz(MCLK); 8kb/1008ms		AIU_SET_LRCLOCK_LEN(0x3F);		// lrclk set as 8.138khz		}	else if (PLL2CLOCK == 153)	{		audio_clock->AudClkC = 0x000013EC;//153/5/15 = 2.04Mhz(MCLK); 8kb/1028ms		AIU_SET_LRCLOCK_LEN(0x3F);		// lrclk set as 7.968khz	        //audio_clock->AudClkC = 0x000013BD;//153/6/12 = 2.125Mhz(MCLK); 8kb/988ms        //AIU_SET_LRCLOCK_LEN(0x3F);		// lrclk set as 8.3khz		}	else if (PLL2CLOCK == 156)	{		audio_clock->AudClkC = 0x000013AE;//156/7/10 = 2.125Mhz(MCLK); 8kb/1036ms		AIU_SET_LRCLOCK_LEN(0x3F);		// lrclk set as 7.913khz		}	else if (PLL2CLOCK == 159)	{		audio_clock->AudClkC = 0x000013CD;//159/6/13 = 2.038Mhz(MCLK); 8kb/1028ms		AIU_SET_LRCLOCK_LEN(0x3F);		// lrclk set as 7.962khz		}	else if (PLL2CLOCK == 162)	{		audio_clock->AudClkC = 0x0000139F;//162/8/10 = 2.025Mhz(MCLK); 8kb/1036ms		AIU_SET_LRCLOCK_LEN(0x3F);		// lrclk set as 7.91khz		}	else if (PLL2CLOCK == 165)	{		audio_clock->AudClkC = 0x0000139F;//165/8/10 = 2.0625Mhz(MCLK); 8kb/1016ms		AIU_SET_LRCLOCK_LEN(0x3F);		// lrclk set as 8.0566khz	}		/*	else if (PLL2CLOCK == 160)	{	        audio_clock->AudClkC = 0x000013BD;//160/6/12 =2.05Mhz(MCLK)	        AIU_SET_LRCLOCK_LEN(0x3F);		// lrclk set as 8.012khz       } 	else if (PLL2CLOCK == 166)       {       	audio_clock->AudClkC = 0x000013BD;//166/6/12 =2.128Mhz(MCLK)	        AIU_SET_LRCLOCK_LEN(0x3F);		// lrclk set as 8.313khz	 }*/    #else/*		audio_clock->PLL3Cfg = 0x00777C7F;		audio_clock->AudClkC = 0x00001350;			AIU_SET_LRCLOCK_LEN(0x3F);	// lrclk set as 8khz, A/D doesn't eat this clock and no sound will come out*/				audio_clock->PLL3Cfg = 0x007761FA;		audio_clock->AudClkC = 0x000013E0;		AIU_SET_LRCLOCK_LEN(0x3F);	// lrclk set as 8.003khz, it works; 8kb/1024ms/*		audio_clock->PLL3Cfg = 0x00771415;		audio_clock->AudClkC = 0x00001350;			AIU_SET_LRCLOCK_LEN(0x3F);	// lrclk set as 8.1845khz, it works; 8kb/1000ms*/#endif		}	else		MP_ALERT("Samplerate %d is not supported by IIS.(Only supports 8K)", sRate);	// If you want to change PLL value, follow below steps	// 1. setting PLL config.	// 2. Disable PLL (ClkCtrl , Clkss_EXT1)	// 3. Re-enable PLL(ClkCtrl , Clkss_EXT1)	#if AUDIO_DAC_USING_PLL2    g_psClock->Clkss_EXT1 &= 0xfffffff0;	#else	g_psClock->Clkss_EXT1 &= 0xfffffff0;	g_psClock->Clkss_EXT1 |= (BIT3);    // Using PLL3/1 to be clock source//	g_psClock->ClkCtrl &= ~0x01000000;		// disable PLL3	g_psClock->ClkCtrl |= 0x01000000;		// enable PLL3	#endif	AIUCLOCK_DISABLE();	AIU_MAINCLOCK_ENABLE();	MP_DEBUG("ES7240_SetDACSampleRate end");}// Setting AIU registers and reset sample rate int  ES7240_PlayConfig(DWORD sampleRate){	MP_DEBUG("ES7240_PlayConfig");	// Mater clock and bit clock setting (If speed is not fast enough, hw i2c will fail.)	g_psClock->PLL3Cfg = 0x0077ffc3;	g_psClock->AudClkC = 0x00001110;	g_psClock->Clkss_EXT1 &= 0xfffffff0;	g_psClock->Clkss_EXT1 |= (BIT3);	 // Using PLL3/1 to be clock source	g_psClock->ClkCtrl &= ~0x01000000;	 // Disable PLL3//	g_psClock->ClkCtrl |= 0x01000000;    // enable PLL3	AIU_PLAYBACK_GAI_INIT();	AIU_SET_GENERAL_WAVEFORM();		ES7240_SetDACSampleRate(sampleRate);	return PASS;}/** *************************************************************** * * Config ES7240 clock and gpio * *  Input  : none. * *  Output : none.  ****************************************************************/  void ES7240_AIUCfg(void){		MP_DEBUG("Audio ES7240_AIUCfg");		g_psClock->PLL3Cfg = 0x007718CC;		g_psClock->AudClkC = 0x00001570;		g_psClock->Clkss_EXT1 &= 0xfffffff0;		g_psClock->Clkss_EXT1 |= (BIT3);	 // Using PLL3/1 to be clock source		g_psClock->Clkss_EXT2 |= 0x00040000;	//Using since mp650 series		g_psClock->ClkCtrl &= ~0x01000000;	 // Disable PLL3		g_psClock->ClkCtrl |= 0x01000000;	 // enable PLL3		// Select External Bit_Clock Source		AIUCLOCK_DISABLE();		AIU_MAINCLOCK_ENABLE();		AIU_LEFT_JUSTIFIED();		// Disable AIU_DMA		g_psDmaAiu->Control = 0x00000000;				// Configure AGPIO to AUDIO Mode		g_psGpio->Agpcfg = 0x0000001F;//		mpDebugPrint("0 g_psAiu->AiuCtl 0x%.8x",g_psAiu->AiuCtl);//		mpDebugPrint("0 g_psAiu->AiuCtl1 0x%.8x",g_psAiu->AiuCtl1);}int ES7240_uninit(){	mpDebugPrint("uninit ES7240");			return PASS;}int AudioInit_ES7240(void){	mpDebugPrint("Audio dec init...ES7240");	ES7240_AIUCfg();//	MP_DEBUG("Audio dec init...ES7240 end");		return PASS;}int AudioInitRec_ES7240(void){	mpDebugPrint("Audio Rec init...ES7240");	ES7240_AIUCfg();	MP_DEBUG("Audio rec init ES7240 finished...");	return PASS;}HAL_AUDIODAC_T _audioDAC_ES7240 ={	AudioInit_ES7240,	AudioInitRec_ES7240,	ES7240_uninit,	ES7240_PlayConfig,	NULL,	ES7240_ChgVolume};#endif